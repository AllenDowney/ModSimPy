
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Under the Hood &#8212; Modeling and Simulation in Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chap27';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="One Queue or Two" href="queue.html" />
    <link rel="prev" title="Case Studies Part 3" href="chap26.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Modeling and Simulation in Python</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Modeling and Simulation in Python
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap01.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">Bike Share System</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">Sweeping Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">World Population</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">Proportional Growth</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">Limits to Growth</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">Projecting Population Growth</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">Analysis of Population Growth</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">Case Studies Part 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap11.html">Epidemiology</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap12.html">Modeling Vaccination</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap13.html">Sweeping Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap14.html">Nondimensionalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap15.html">Cooling Coffee</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap16.html">Adding Milk</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap17.html">Pharmacokinetics</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap18.html">Glucose and Insulin</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap19.html">Case Studies Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap20.html">The Empire State Building Strikes Back</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap21.html">Drag</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap22.html">Baseball</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap23.html">Optimal Baseball</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap24.html">Rotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap25.html">Torque</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap26.html">Case Studies Part 3</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Under the Hood</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="queue.html">One Queue or Two</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://allendowney.github.io/ModSimPy/api/index.html">API Documentation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/ModSimPy" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/chap27.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Under the Hood</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-run-solve-ivp-works">How run_solve_ivp Works</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-root-scalar-works">How root_scalar Works</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-maximize-scalar-works">How maximize_scalar Works</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p>Printed and electronic copies of <em>Modeling and Simulation in Python</em> are available from <a class="reference external" href="https://nostarch.com/modeling-and-simulation-python">No Starch Press</a> and <a class="reference external" href="https://bookshop.org/p/books/modeling-and-simulation-in-python-allen-b-downey/17836697?ean=9781718502161">Bookshop.org</a> and <a class="reference external" href="https://amzn.to/3y9UxNb">Amazon</a>.</p>
<section class="tex2jax_ignore mathjax_ignore" id="under-the-hood">
<h1>Under the Hood<a class="headerlink" href="#under-the-hood" title="Link to this heading">#</a></h1>
<p>In this appendix we “open the hood,” looking more closely at how some of
the tools we have used work: specifically, <code class="docutils literal notranslate"><span class="pre">run_solve_ivp</span></code>, <code class="docutils literal notranslate"><span class="pre">root_scalar</span></code>, and <code class="docutils literal notranslate"><span class="pre">maximize_scalar</span></code>.</p>
<p>Most of the time you don’t need to know, you can use these methods without knowing much about how they work.
But there are a few reasons you might <em>want</em> to know.</p>
<p>One reason is pure curiosity.
If you use these methods, and especially if you come to rely on them, you might find it unsatisfying to treat them as black boxes.
In that case, you might enjoy opening the hood.</p>
<p>Another is that these methods are not infallible; sometimes things go wrong.
If you know how they work, at least in a general sense, you might find it easier to debug them.</p>
<p>And if nothing else, I have found that I can remember how to use these tools more easily because I know something about how they work.</p>
<section id="how-run-solve-ivp-works">
<h2>How run_solve_ivp Works<a class="headerlink" href="#how-run-solve-ivp-works" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">run_solve_ivp</span></code> is a function in the ModSimPy library that checks for common errors in the parameters and then calls <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code>, which is the function in the SciPy library that does the actual work.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> uses the <em>Dormand-Prince method</em>, which is a kind of <em>Runge-Kutta method</em>. You can read about it at
<a class="reference external" href="https://en.wikipedia.org/wiki/Dormand-Prince_method">https://en.wikipedia.org/wiki/Dormand-Prince_method</a>, but I’ll give you a sense of
it here.</p>
<p>The key idea behind all Runge-Kutta methods is to evaluate the slope function several times at each time step and use a weighted average of the computed slopes to estimate the value at the next time step.
Different methods evaluate the slope function in different places and compute the average with different weights.</p>
<p>So let’s see if we can figure out how <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> works.
As an example, we’ll solve the following differential equation:</p>
<div class="math notranslate nohighlight">
\[\frac{dy}{dt}(t) = y \sin t\]</div>
<p>Here’s the slope function we’ll use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">slope_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
    <span class="n">y</span><span class="p">,</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">dydt</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dydt</span>
</pre></div>
</div>
</div>
</div>
<p>I’ll create a <code class="docutils literal notranslate"><span class="pre">State</span></code> object with the initial state and a <code class="docutils literal notranslate"><span class="pre">System</span></code> object with the end time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">t_end</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can call <code class="docutils literal notranslate"><span class="pre">run_solve_ivp</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">run_solve_ivp</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">slope_func</span><span class="p">)</span>
<span class="n">details</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  message: &#39;The solver successfully reached the end of the integration interval.&#39;
     nfev: 50
     njev: 0
      nlu: 0
      sol: &lt;scipy.integrate._ivp.common.OdeSolution object at 0x7ff89741a3e0&gt;
   status: 0
  success: True
 t_events: None
 y_events: None
</pre></div>
</div>
</div>
</div>
<p>One of the variables in <code class="docutils literal notranslate"><span class="pre">details</span></code> is <code class="docutils literal notranslate"><span class="pre">nfev</span></code>, which stands for “number of function evaluations”, that is, the number of times <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> called the slope function.
This example took 50 evaluations.
Keep that in mind.</p>
<p>Here are the first few time steps in <code class="docutils literal notranslate"><span class="pre">results</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.00</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>0.03</th>
      <td>1.000450</td>
    </tr>
    <tr>
      <th>0.06</th>
      <td>1.001801</td>
    </tr>
    <tr>
      <th>0.09</th>
      <td>1.004055</td>
    </tr>
    <tr>
      <th>0.12</th>
      <td>1.007217</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>And here is the number of time steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>101
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">results</span></code> contains 101 points that are equally spaced in time.
Now you might wonder, if <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> ran the slope function 50 times, how did we get 101 time steps?</p>
<p>To answer that question, we need to know more about how the solver works.
There are actually three stages:</p>
<ol class="arabic simple">
<li><p>For each time step, <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> evaluates the slope function seven times, with different values of <code class="docutils literal notranslate"><span class="pre">t</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p></li>
<li><p>Using the results, it computes the best estimate for the value <code class="docutils literal notranslate"><span class="pre">y</span></code> at the next time step.</p></li>
<li><p>After computing all of the time steps, it uses interpolation to compute equally spaced points that connect the estimates from the previous step.</p></li>
</ol>
<p>To show the first two steps, I’ll modify the slope function so that every time it runs, it adds the values of <code class="docutils literal notranslate"><span class="pre">t</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">dydt</span></code> to a list called <code class="docutils literal notranslate"><span class="pre">evals</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">slope_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
    <span class="n">y</span><span class="p">,</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">dydt</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">evals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dydt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dydt</span>
</pre></div>
</div>
</div>
</div>
<p>Before we call <code class="docutils literal notranslate"><span class="pre">run_solve_ivp</span></code>, I’ll initialize <code class="docutils literal notranslate"><span class="pre">evals</span></code> with an empty list.
And I’ll use the keyword argument <code class="docutils literal notranslate"><span class="pre">dense_output=False</span></code>, which skips the interpolation step and returns time steps that are not equally spaced (that is, not “dense”).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">results2</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">run_solve_ivp</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">slope_func</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.000000</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>0.000100</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>0.001100</th>
      <td>1.000001</td>
    </tr>
    <tr>
      <th>0.011100</th>
      <td>1.000062</td>
    </tr>
    <tr>
      <th>0.111100</th>
      <td>1.006184</td>
    </tr>
    <tr>
      <th>1.111100</th>
      <td>1.744448</td>
    </tr>
    <tr>
      <th>2.343272</th>
      <td>5.464568</td>
    </tr>
    <tr>
      <th>3.000000</th>
      <td>7.318271</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Because we skipped the interpolation step, we can see that <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> computed only seven time steps, not including the initial condition.
Also, we see that the time steps are different sizes.
The first is only 100 microseconds, the second is about 10 times bigger, and the third is 10 times bigger than that.</p>
<p>The time steps are not equal because the Dormand-Prince method is <em>adaptive</em>.
At each time step, it computes two estimates of the next
value. By comparing them, it can estimate the magnitude of the error,
which it uses to adjust the time step. If the error is too big, it uses
a smaller time step; if the error is small enough, it uses a bigger time
step. By adjusting the time step in this way, it minimizes the number
of times it calls the slope function to achieve a given level of
accuracy.
In this example, it takes five steps to simulate the first second, but then only two more steps to compute the remaining two seconds.</p>
<p>Because we saved the values of <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">t</span></code>, we can plot the locations where the slope function was evaluated.
I’ll need to use a couple of features we have not seen before, if you don’t mind.</p>
<p>First we’ll unpack the values from <code class="docutils literal notranslate"><span class="pre">evals</span></code> using <code class="docutils literal notranslate"><span class="pre">np.transpose</span></code>.
Then we can use trigonometry to convert the slope, <code class="docutils literal notranslate"><span class="pre">dydt</span></code>, to components called <code class="docutils literal notranslate"><span class="pre">u</span></code> and <code class="docutils literal notranslate"><span class="pre">v</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Using these values, we can generate a <em>quiver plot</em> that shows an arrow for each time the slope function ran.
The location of each arrow represents the values of <code class="docutils literal notranslate"><span class="pre">t</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>; the orientation of the arrow shows the slope that was computed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span> 
           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;evaluation points&#39;</span><span class="p">)</span>
<span class="n">results2</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;solution points&#39;</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;interpolation&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (t)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Quantity (y)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e0ae4d44ea08176dfce12482585d69852381fb997f0d678cc5eccf866bf8e11e.png" src="_images/e0ae4d44ea08176dfce12482585d69852381fb997f0d678cc5eccf866bf8e11e.png" />
</div>
</div>
<p>In this figure, there are 50 arrows, one for each time the slope function was evaluated, and 8 dots, one for each time step (although several of them overlap).
The line shows the 101 points in the interpolation that connects the estimates.</p>
<p>Notice that many of the arrows do not fall on the line; <code class="docutils literal notranslate"><span class="pre">solve_ivp</span></code> evaluated the slope function at these locations in order to compute the solution, but as it turned out, they are not part of the solution.</p>
<p>This is good to know when you are writing a slope function; you should not assume that the time and state you get as input variables are correct.</p>
</section>
<section id="how-root-scalar-works">
<h2>How root_scalar Works<a class="headerlink" href="#how-root-scalar-works" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">root_scalar</span></code> in the ModSim library is a wrapper for a function in the SciPy library with the same name.
Like <code class="docutils literal notranslate"><span class="pre">run_solve_ivp</span></code>, it checks for common errors and changes some of the parameters in a way that makes the SciPy function easier to use (I hope).</p>
<p>According to the documentation, <code class="docutils literal notranslate"><span class="pre">root_scalar</span></code> uses “a combination of bisection, secant, and inverse quadratic interpolation methods.” (See
<a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.root_scalar.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.root_scalar.html</a>)</p>
<p>To understand what that means, suppose we’re trying to find a root of a
function of one variable, <span class="math notranslate nohighlight">\(f(x)\)</span>, and assume we have evaluated the
function at two places, <span class="math notranslate nohighlight">\(x_1\)</span> and <span class="math notranslate nohighlight">\(x_2\)</span>, and found that the results have
opposite signs. Specifically, assume <span class="math notranslate nohighlight">\(f(x_1) &gt; 0\)</span> and <span class="math notranslate nohighlight">\(f(x_2) &lt; 0\)</span>, as
shown in the following diagram:</p>
<p><img alt="Initial state of a root-finding search" src="https://github.com/AllenDowney/ModSim/raw/main/figs/secant.png" /></p>
<p>If <span class="math notranslate nohighlight">\(f\)</span> is a continuous function, there must be at least one root in this
interval. In this case we would say that <span class="math notranslate nohighlight">\(x_1\)</span> and <span class="math notranslate nohighlight">\(x_2\)</span> <em>bracket</em> a
root.</p>
<p>If this were all you knew about <span class="math notranslate nohighlight">\(f\)</span>, where would you go looking for a
root? If you said “halfway between <span class="math notranslate nohighlight">\(x_1\)</span> and <span class="math notranslate nohighlight">\(x_2\)</span>,” congratulations!
`You just invented a numerical method called <em>bisection</em>!</p>
<p>If you said, “I would connect the dots with a straight line and compute
the zero of the line,” congratulations! You just invented the <em>secant
method</em>!</p>
<p>And if you said, “I would evaluate <span class="math notranslate nohighlight">\(f\)</span> at a third point, find the
parabola that passes through all three points, and compute the zeros of
the parabola,” congratulations, you just invented <em>inverse quadratic
interpolation</em>!</p>
<p>That’s most of how <code class="docutils literal notranslate"><span class="pre">root_scalar</span></code> works. The details of how these methods are
combined are interesting, but beyond the scope of this book. You can
read more at <a class="reference external" href="https://en.wikipedia.org/wiki/Brents_method">https://en.wikipedia.org/wiki/Brents_method</a>.</p>
</section>
<section id="how-maximize-scalar-works">
<h2>How maximize_scalar Works<a class="headerlink" href="#how-maximize-scalar-works" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">maximize_scalar</span></code> in the ModSim library is a wrapper for a function in the SciPy library called <code class="docutils literal notranslate"><span class="pre">minimize_scalar</span></code>.
You can read about it at <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize_scalar.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize_scalar.html</a>.</p>
<p>By default, it uses Brent’s method, which is related to the method I described in the previous section for root-finding.
Brent’s method for finding a maximum or minimum is based on a simpler algorithm:
the <em>golden-section search</em>, which I will explain.</p>
<p>Suppose we’re trying to find the minimum of a function of a single variable, <span class="math notranslate nohighlight">\(f(x)\)</span>.
As a starting place, assume that we have evaluated the function at three
places, <span class="math notranslate nohighlight">\(x_1\)</span>, <span class="math notranslate nohighlight">\(x_2\)</span>, and <span class="math notranslate nohighlight">\(x_3\)</span>, and found that <span class="math notranslate nohighlight">\(x_2\)</span> yields the lowest
value. The following diagram shows this initial state.</p>
<p><img alt="Initial state of a golden-sectionsearch" src="https://github.com/AllenDowney/ModSim/raw/main/figs/golden1.png" /></p>
<p>We will assume that <span class="math notranslate nohighlight">\(f(x)\)</span> is continuous and <em>unimodal</em> in this range,
which means that there is exactly one minimum between <span class="math notranslate nohighlight">\(x_1\)</span> and <span class="math notranslate nohighlight">\(x_3\)</span>.</p>
<p>The next step is to choose a fourth point, <span class="math notranslate nohighlight">\(x_4\)</span>, and evaluate <span class="math notranslate nohighlight">\(f(x_4)\)</span>.
There are two possible outcomes, depending on whether <span class="math notranslate nohighlight">\(f(x_4)\)</span> is
greater than <span class="math notranslate nohighlight">\(f(x_2)\)</span> or not.
The following figure shows the two possible states.</p>
<p><img alt="" src="https://github.com/AllenDowney/ModSim/raw/main/figs/golden2.png" /></p>
<p>If <span class="math notranslate nohighlight">\(f(x_4)\)</span> is less than <span class="math notranslate nohighlight">\(f(x_2)\)</span> (shown on the left), the minimum must
be between <span class="math notranslate nohighlight">\(x_2\)</span> and <span class="math notranslate nohighlight">\(x_3\)</span>, so we would discard <span class="math notranslate nohighlight">\(x_1\)</span> and proceed with
the new bracket <span class="math notranslate nohighlight">\((x_2, x_4, x_3)\)</span>.</p>
<p>If <span class="math notranslate nohighlight">\(f(x_4)\)</span> is greater than <span class="math notranslate nohighlight">\(f(x_2)\)</span> (shown on the right), the local
minimum must be between <span class="math notranslate nohighlight">\(x_1\)</span> and <span class="math notranslate nohighlight">\(x_4\)</span>, so we would discard <span class="math notranslate nohighlight">\(x_3\)</span> and
proceed with the new bracket <span class="math notranslate nohighlight">\((x_1, x_2, x_4)\)</span>.</p>
<p>Either way, the range gets smaller and our estimate of the optimal value
of <span class="math notranslate nohighlight">\(x\)</span> gets better.</p>
<p>This method works for almost any value of <span class="math notranslate nohighlight">\(x_4\)</span>, but some choices are
better than others. You might be tempted to bisect the interval between
<span class="math notranslate nohighlight">\(x_2\)</span> and <span class="math notranslate nohighlight">\(x_3\)</span>, but that turns out not to be optimal. You can
read about a better option at <a class="reference external" href="https://greenteapress.com/matlab/golden">https://greenteapress.com/matlab/golden</a>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="chap26.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Case Studies Part 3</p>
      </div>
    </a>
    <a class="right-next"
       href="queue.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">One Queue or Two</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-run-solve-ivp-works">How run_solve_ivp Works</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-root-scalar-works">How root_scalar Works</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-maximize-scalar-works">How maximize_scalar Works</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>